<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterSortPuzzle_Prot</title>
    <style>
        .unit {
            display: inline-block;
            border-right: 2px solid black;
            border-bottom: 2px solid black;
            border-left: 2px solid black;
            z-index: 1;
            /* z-indexã‚’è¨­å®š */

        }

        #debug_log {
            display: inline-block
        }

        .test_tube {
            padding: 1px;
            margin: 6px;
            /* width:16px;
            height:90px; */
            color: black;
            font-size: xx-large;
            line-height: 1.05;
            display: inline-block
        }

        .hidden {
            visibility: hidden;
            pointer-events: none
        }

        .blue {
            color: blue;
            pointer-events: none
        }

        .red {
            color: red;
            pointer-events: none
        }

        .yellow {
            color: yellow;
            pointer-events: none
        }

        .green {
            color: green;
            pointer-events: none
        }

        .yellow_green {
            color: yellowgreen;
            pointer-events: none
        }

        .palevioletred {
            color: palevioletred;
            pointer-events: none
        }

        .purple {
            color: purple;
            pointer-events: none
        }

        .skyblue {
            color: skyblue;
            pointer-events: none
        }

        .gray {
            color: gray;
            pointer-events: none
        }
    </style>
</head>

<body>
    <h1>WaterSortPuzzle_Prot</h1>
    <div id="game_screen">


        <!-- ã©ã†ã›ã“ã“ã¯ä¸Šæ›¸ãã•ã‚Œã‚‹-->

        <div class="test_tube 0">

            <div class="space">
                <div class="blue">â–ˆ<br></div>
                <div class="blue">â–ˆ<br></div>
                <div class="hidden">â–ˆ<br></div>
                <div class="hidden">â–ˆ<br></div>
            </div>

            <div class="unit">
                <div class="hidden">â–ˆ<br></div>
                <div class="hidden">â–ˆ<br></div>
                <div class="red">â–ˆ<br></div>
                <div class="red">â–ˆ<br></div>
            </div>


        </div>

        <!-- -->

    </div>

    <div id="text_area">
        <div id="debug_log">

        </div>

        <div>
            éŠã³æ–¹<br>
            <br>
            è©¦é¨“ç®¡ã®ã¤ã‚‚ã‚Šã§ä½œã£ãŸã‚¯ã‚½ã¿ãŸã„ãªçµµï¼ˆãã£ãŸã­ãˆï¼‰ã®ä¸­ã«ã‚ã‚‹<br>
            ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€å…¨ã¦åŒã˜è©¦é¨“ç®¡ã«ç¶ºéº—ã«æƒãˆã‚‹ã ã‘ã®ç°¡å˜ãªã‚²ãƒ¼ãƒ ã ã‚ˆ<br>
            <br>
            å¥½ããªè©¦é¨“ç®¡ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä¸€ç•ªä¸Šã®æƒã£ãŸè‰²ã‚’çºã‚ã¦ç§»å‹•ã§ãã‚‹ã‚ˆ<br>
            ãã‚Œã‚’å¥½ããªæ‰€ã«é…ç½®ã—ã¦ç¶ºéº—ã«æƒãˆã‚ˆã†ï¼<br>
            <br>
            â€¦ã‚“ï¼Ÿãƒ—ãƒªãƒ³ã‚»ã‚¹ãŠã²ã‚ã•ã¾ã®äº‹ã ã‹ã‚‰ã€Œå¤§äº‹ãªã“ã¨è¨€ã£ã¦ãªã„ã ã‚ï¼Ÿã€ã£ã¦ï¼Ÿ<br>
            <br>
            äººèãæ‚ªã„ãªãï½—ã¾ãã‚„ã£ã¦ã¿ã‚Œã°ã‚ã‹ã‚‹ã•ï½—ç°¡å˜ã ã‹ã‚‰ï½—<br>
            <br>
        </div>

        <div id="ascii_art">

        </div>
    </div>


</body>


<script>
    //ä¸€æšã®ãƒ•ã‚¡ã‚¤ãƒ«ã«çºã‚ãŸã„ã®ã§ã€ã‚ãˆã¦å¤–éƒ¨ã¯ä¸­æ­¢
    //å®šæ•°

    //æç”»å‡¦ç†

    const HORIZONTAL_LINE = 5;//5
    const VERTICAL_LINE = 2;//2
    const BLOCK_MAX = 4;
    const START_FREE_TEST_TUBE = 2;
    const START_USE_TEST_TUBE = HORIZONTAL_LINE * VERTICAL_LINE - START_FREE_TEST_TUBE;
    const BLOCK_CHAR = "â–ˆ";
    //const BLOCK_CHAR ="â™¥";
    //const BLOCK_CHAR ="ğŸ¤“";
    //const BLOCK_CHAR ="ç‰›è§’ã®ç”·æ€§å·®åˆ¥å•†æ³•ã€‚ç§ã®å°ç«ç·šã«ç«ãŒã¤ã„ãŸã€‚çµ¶å¯¾ã‚†ã‚‹ã•ã­ã‡ãã€‚ä»Šã¾ã§å€‹äººåº—ã®ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ãƒ‡ãƒ¼ã¯æ•°ãˆåˆ‡ã‚Œãªã„ã»ã©æ½°ã—ã¦ããŸã‘ã©ã€ä»Šåº¦ã¯åã®é€šã£ãŸä¼æ¥­ç›¸æ‰‹ã ã‹ã‚‰ã€å…¨èº«å…¨éœŠã§æˆ¦ã„ã‚’æŒ‘ã‚“ã§ã‚„ã‚‹ã€‚ä¹…ã€…ã«é—˜å¿—ãŒæ²¸ã„ã¦ããŸã‚ˆã€‚åˆæ³•ã®ç¯„å›²ã§ä½¿ãˆã‚‹æ‰‹ã¯ã©ã‚“ãªæ‰‹ã‚’ä½¿ã£ã¦ã§ã‚‚æˆ¦ã£ã¦ã‚„ã‚‹";
    const COLORS = ["none", "blue", "red", "yellow", "green", "yellow_green", "palevioletred", "purple", "skyblue", "glay"];


    //ä¸€æ¬¡å…ƒé…åˆ—ã‚’ï¼’æ¬¡å…ƒé…åˆ—ã«å¤‰æ›ã™ã‚‹
    function convertTo2DArrayFrom(array, length) {
        return Array.from({ length: Math.ceil(array.length / length) }, (_, i) =>
            array.slice(i * length, (i + 1) * length)
        );
    }

    //å®Ÿãƒ‡ãƒ¼ã‚¿
    class GameData {
        static SELECT_NONE = -1;
        #select_index = GameData.SELECT_NONE;
        #pick_array = [];
        #block_datas = [[]];


        paramStrings() {

            var test_tubes_param = ``;

            for (let i = 0; i < this.block_datas.length; i++) {
                test_tubes_param += `num${i} : `;
                for (let j = 0; j < this.block_datas[i].length; j++) {
                    test_tubes_param += `${this.block_datas[i][j]} `;
                }
                test_tubes_param += `<br>`;
            }

            return `
            select index = ${this.select_index}<br>
            pick_array length = ${this.pick_array.length}<br>
            test_tube num = ${this.block_datas.length}<br>
              test tubes<br>
              ${test_tubes_param}
        `
        }

        InitializedTestTube() {
            //this.pick_array = [];
            var arr = [];
            // å†…éƒ¨ç”Ÿæˆ
            {
                for (let i = 0; i < START_USE_TEST_TUBE; i++) {
                    for (let j = 0; j < BLOCK_MAX; j++) {
                        arr.push(i + 1);
                    }
                }
            }
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆFisher-Yates shuffleï¼‰
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]]; // è¦ç´ ã®å…¥ã‚Œæ›¿ãˆ
            }

            //ç©ºã®è©¦é¨“ç®¡è¿½åŠ 
            {
                for (let i = 0; i < BLOCK_MAX * START_FREE_TEST_TUBE; i++) {
                    arr.push(0);
                }
            }

            //ï¼’æ¬¡å…ƒé…åˆ—åŠ å·¥
            this.block_datas = convertTo2DArrayFrom(arr, BLOCK_MAX);
        }

        InitializedParams() {
            //todo ã‚ã¨ã§å®Ÿè£…
        }

        Initialized() {
            this.pick_array = [];
            this.InitializedTestTube();
            this.InitializedParams();
        }

        pushCheck(index, block_id) {
            if (this.getBlockCount(index) == 0) return true;
            if (block_id == this.fetch(index)) return true;
            return false;
        }

        pushSingle(target_idx, block_id) {
            let idx = this.block_datas[target_idx].lastIndexOf(0);
            if (idx === -1) { return false; }
            this.block_datas[target_idx][idx] = block_id;
            return true;
        }

        fetch(target_idx) {
            return this.block_datas[target_idx][this.getBlockBlank(target_idx)];
        }

        push(target_idx, block_arr) {
            //ä¸–ç•ŒãŒé€†ã«å›è»¢ã™ã‚‹æ—¥å¸¸ã‚’é£›ã³è¶Šãˆï½â™ªå·±ã®ä½“ã¨ãã®å…¨ã¦ã®å­˜åœ¨å¦å®šã¯ã•ã›ãªã„â™ª
            [...block_arr].reverse().forEach(pick_id => {
                if (this.pushSingle(target_idx, pick_id)) {
                    block_arr.pop();//XXX:ãŸã¶ã‚“æ¶ˆã—ã¦ã‚‹ãƒ–ãƒ­ãƒƒã‚¯åŒã˜ã ã‹ã‚‰å‹•ä½œã¯ã™ã‚‹ãŒã€æ¶ˆã—ã¦ã‚‹ã‚„ã¤ã¯æœ¬å½“ã«æ­£ã—ã„ã‹ï¼Ÿ
                }
            });
            return block_arr;
        }

        onTap(select_idx) {

            //let IS_TAP_SELECT_INDEX = this.select_index == select_idx;
            let IS_PICKMODE = this.pick_array.length > 0;
            if (IS_PICKMODE) {
                let IS_DIFF_INDEX = this.select_index != select_idx;
                console.log(`is diff index ${IS_DIFF_INDEX}`);
                if (IS_DIFF_INDEX) {
                    if (this.pushCheck(select_idx, this.pick_array[this.pick_array.length - 1])) {
                        this.pick_array = this.push(select_idx, this.pick_array);
                        if (this.pick_array.length == 0) {
                            this.select_index = select_idx;
                        }
                    } else {
                        //ã§ãã‚‹ãªã‚‰ã„ã‚Œã‚Œãªã„æ—¨ã®å‡¦ç†
                    }
                } else {
                    this.pick_array = this.push(select_idx, this.pick_array);

                    this.select_index = select_idx;

                }

            } else {
                for (let i = this.getBlockBlank(select_idx); i < this.block_datas[select_idx].length; i++) {

                    if (this.pick_array.length != 0) {
                        if (this.pick_array[0] != this.block_datas[select_idx][i] //å‰å›å…¥æ‰‹ã—ãŸè‰²ã¨é•ã†
                        ) {
                            break;
                        }
                    }

                    this.pick_array.push(this.block_datas[select_idx][i]);
                    this.block_datas[select_idx][i] = 0;

                }

                this.select_index = select_idx;
            }
        }

        getBlockCount(idx) {
            return this.block_datas[idx].filter(id => id !== 0).length;
        }

        getBlockBlank(idx) {
            return this.block_datas[idx].filter(id => id === 0).length;
        }

        pick(idx) {
            return this.pick_array[idx];
        }

        pickLength() {
            return this.pick_array.length;
        }

        selectIndex() {
            return this.select_index;
        }


    };

    let game_data = new GameData();
    game_data.Initialized();

    function UpdateScreen() {

        var test_tube_index = 0;
        var html = ``;
        game_data.block_datas.forEach(row => {

            html += `<div class="test_tube">`;

            //è©¦é¨“ç®¡ä¸Šéƒ¨æç”»
            let IS_SELECT_INDEX = game_data.selectIndex() == test_tube_index;
            if (IS_SELECT_INDEX)//ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­
            {
                html += `<div class="space">`;
                for (let i = 0; i < BLOCK_MAX; i++) {
                    if (i < game_data.pickLength()) {
                        html += `<div class="${COLORS[game_data.pick(i)]}">${BLOCK_CHAR}<br></div>`;
                        //html += `<div class="blue">â–ˆ<br></div>`;
                    } else {
                        html += `<div class="hidden">${BLOCK_CHAR}<br></div>`;
                    }
                }
                html += `</div>`;
            } else {
                html += `<div class="space">
            <div class="hidden">${BLOCK_CHAR}<br></div>
            <div class="hidden">${BLOCK_CHAR}<br></div>
            <div class="hidden">${BLOCK_CHAR}<br></div>
            <div class="hidden">${BLOCK_CHAR}<br></div>
            </div>
            `
            }

            //è©¦é¨“ç®¡å†…éƒ¨æç”»
            html += `<div class="unit unit${test_tube_index}">
                `
            row.forEach(element => {

                if (element === 0) {
                    html += `<div class="hidden">${BLOCK_CHAR}<br></div>
                    `;
                } else {
                    html += `<div class="${COLORS[element]}">${BLOCK_CHAR}<br></div>
                    `;
                }


            });


            html += `</div>
            </div>
            `;

            test_tube_index += 1;
        });


        const game_screen = document.getElementById("game_screen");
        game_screen.innerHTML = html;

        if (false) {
            const debug_log = document.getElementById("debug_log");
            debug_log.innerHTML = game_data.paramStrings();
        }


        const ascii_art = document.getElementById("ascii_art");

        var aa = "";

        aa += "OKã€ãƒ–ãƒ©ã‚¯ãƒ©ã‚²ãƒƒãƒˆã€‚<br>";
        aa += "ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€âˆ§ï¼¿âˆ§<br>";
        aa += "ã€€ã€€ã€€ã€€ âˆ§ï¼¿âˆ§ ã€€ï¼ˆÂ´<_ï½€ ï¼‰ã€€æµçŸ³ã ã‚ˆãªä¿ºã‚‰ã€‚<br>";
        aa += "ã€€ã€€ã€€ï¼ˆã€€Â´_ã‚`ï¼‰/ã€€ã€€ âŒ’i<br>";
        aa += "ã€€ã€€ ï¼ã€€ã€€ã€€ï¼¼./ ã€€ã€€|ã€€|<br>";
        aa += "ã€€ã€€/ã€€ã€€ ã€€/ï¿£ï¿£ï¿£ï¿£/ã€€|<br>";
        aa += "ï¼¿_(__ï¾†ã¤/ã€€ FMVã€€ / .| .|ï¼¿ï¼¿ï¼¿ï¼¿<br>";
        aa += "ã€€ã€€ã€€ ï¼¼/ï¼¿ï¼¿ï¼¿ï¼¿/ã€€ï¼ˆuã€€âŠƒ<br>";
        ascii_art.innerHTML = aa;


    }


    UpdateScreen();

    //å…¥åŠ›å¯¾å¿œ
    const container = document.getElementById("game_screen");

    let MAX_INDEX = game_data.block_datas.length;
    for (let i = 0; i < MAX_INDEX; i++) {
        container.addEventListener("click", function (event) {
            if (event.target.classList.contains(`unit${i}`)) {
                //alert(`${i}ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                let SELECT_IDX = i;

                game_data.onTap(SELECT_IDX);

                UpdateScreen();

            }
        });
    }



</script>


</html>